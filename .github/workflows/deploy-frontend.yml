name: Deploy Frontend to Amplify

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Select GitHub Environment
    environment: ${{ github.ref_name == 'main' && 'Prod' || 'Test' }}

    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1   # change if needed

      # 3️⃣ Update Amplify environment variables
      - name: Update Amplify environment variables
        run: |
          aws amplify update-app \
            --app-id "${{ secrets.AMPLIFY_APP_ID }}" \
            --environment-variables "{
              \"VITE_SUPABASE_URL\":\"${{ secrets.VITE_SUPABASE_URL }}\",
              \"VITE_SUPABASE_ANON_KEY\":\"${{ secrets.VITE_SUPABASE_ANON_KEY }}\"
            }"

      # 4️⃣ Start Amplify build
      - name: Start Amplify build
        id: start_build
        run: |
          JOB_ID=$(aws amplify start-job \
            --app-id "${{ secrets.AMPLIFY_APP_ID }}" \
            --branch-name "${{ github.ref_name }}" \
            --job-type RELEASE \
            --query "jobSummary.jobId" \
            --output text)

          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
          echo "Started Amplify job: $JOB_ID"

      # 5️⃣ Wait for Amplify build to finish
      - name: Wait for Amplify build
        run: |
          echo "Waiting for Amplify job $JOB_ID..."

          while true; do
            STATUS=$(aws amplify get-job \
              --app-id "${{ secrets.AMPLIFY_APP_ID }}" \
              --branch-name "${{ github.ref_name }}" \
              --job-id "$JOB_ID" \
              --query "job.summary.status" \
              --output text)

            echo "Current status: $STATUS"

            if [ "$STATUS" = "SUCCEED" ]; then
              echo "Amplify deployment succeeded"
              exit 0
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "Amplify deployment failed"
              exit 1
            fi

            sleep 20
          done