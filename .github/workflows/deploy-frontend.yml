name: Deploy Frontend to Amplify

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ðŸ”‘ This selects GitHub Environment
    environment: ${{ github.ref_name == 'main' && 'Prod' || 'Test' }}

    steps:
      #  Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      #  Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east   # change if needed

      #  Inject env vars into Amplify (JSON is REQUIRED)
      - name: Update Amplify environment variables
        run: |
          aws amplify update-app \
            --app-id "${{ secrets.AMPLIFY_APP_ID }}" \
            --environment-variables "{
              \"VITE_SUPABASE_URL\":\"${{ secrets.VITE_SUPABASE_URL }}\",
              \"VITE_SUPABASE_ANON_KEY\":\"${{ secrets.VITE_SUPABASE_ANON_KEY }}\"
            }"

      #  Trigger Amplify build & deploy
      - name: Trigger Amplify deployment
        run: |
          aws amplify start-job \
            --app-id "${{ secrets.AMPLIFY_APP_ID }}" \
            --branch-name "${{ github.ref_name }}" \
            --job-type RELEASE